---
title: "md and themed html documents"
subtitle: Subtitle
author: "Your name"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    theme: united
    keep_md: true
---

# Setup

```{r setup, include=FALSE}
# This chunk named setup will run before any other code (https://goo.gl/BeM2Uu)
set.seed(1014)
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  # Figures (http://r4ds.had.co.nz/)
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,
  fig.show = "hold"
)
```

## Functions

```{r functions}
# Crucial column names
crucial <- c("PlotName", "Status", "DBH", "ExactDate", "PlotCensusNumber")

commas <- function(...) {
  paste0(..., collapse = ", ")
}

# @export
pick_plotname <- function(vft, plot_nm = sort(unique(vft$PlotName))) {
  if (length(plot_nm) > 1) {
    warning(
      "Detected more than one `PlotName`: (", commas(plot_nm), ")\n",
      "* Using ", plot_nm[[1]],
      call. = FALSE
    )
  }
  dplyr::filter(vft, PlotName == plot_nm[[1]])
}



warn_if_bad_status <- function(vft, status_arg) {
  status_col <- vft$Status
  if (!identical_status_levels(status_col, status_arg)) {
    warning(
      "Unique values of column `Status` and argument `valid_status` ", 
      "should match:\n",
      "* Status col: ", commas(sort(unique(status_arg))), ".\n",
      "* valid_status arg: ", commas(sort(unique(status_col))), ".",
      call. = FALSE
    )
  }
  invisible(vft)
}

identical_status_levels <- function(status_col, status_arg) {
  identical(sort(unique(status_col)), sort(unique(status_arg)))
}



fix_status_if_bad_or_err <- function(vft, status_arg) {
  if (!identical_status_levels(vft$Status, status_arg)) {
    message("Fixing status automatically.")
    vft <- fix_bad_status(vft, vft$Status, status_arg)
    
    tryCatch(
      testthat::expect_silent(warn_if_bad_status(vft, status_arg)),
      error = function(cond) {
        stop("Tried but failed to fix status automatically.", call. = FALSE)
      },
      warning = function(cond) "Failed to fix status automatically."
    )
  }
  invisible(vft)
}

fix_bad_status <- function(vft, status_col, status_arg) {
  vft$Status <- sub("^.*dead.*$", "dead", vft$Status)
  vft$Status <- sub("^.*alive.*$", "alive", vft$Status)
  vft
}



drop_if_missing_dbh <- function(dfm) {
  missing_dbh <- is.na(dfm$DBH)
  if (any(missing_dbh)) {
    warning(
      "Dropping ", sum(missing_dbh), " rows with missing `DBH` values.", 
      call. = FALSE
    )
  }
  dplyr::filter(dfm, !is.na(DBH))
}



drop_if_missing_dates <- function(x) {
  missing_dates <- is.na(x$ExactDate)
  if (any(missing_dates)) {
    warning("Detected and dropping missing dates.", call. = FALSE)
  }
  x <- x[!missing_dates, , drop = FALSE]
  invisible(x)
}



mean_years <- function(vft) {
  years <-  vft %>% 
    dplyr::group_by(PlotCensusNumber) %>% 
    dplyr::summarise(year = round(mean(year(ExactDate), na.rm = TRUE))) %>% 
    unique() %>% 
    dplyr::arrange(PlotCensusNumber) %>% 
    dplyr::ungroup()
  with_year <- dplyr::left_join(not_na_dates, years, by = "PlotCensusNumber") %>% 
    dplyr::mutate(species = paste(Genus, SpeciesName)) %>% 
    dplyr::arrange(year)
}



fgeo_abundance <- function(vft) {
  vft %>% 
    dplyr::count(species, Family, year) %>% 
    tidyr::spread(year, n, fill = 0) %>% 
    arrange(species, Family)
}



fgeo_basal_area <- function(vft) {
  vft %>% 
    dplyr::group_by(species, Family, year) %>%
    basal_area(dbh = DBH) %>% 
    dplyr::arrange(species, Family, year) %>% 
    dplyr::ungroup() %>% 
    tidyr::spread(year, basal_area, fill = 0)
}

```

## Packages.

```{r packages}
set.seed(1)

library(dplyr)
library(tidyr)
library(lubridate)
library(fgeo.base)
library(fgeo.tool)

library(fgeo.abundance)
library(tidyverse)
library(here)
library(fs)
```

# Task

> Cocoli should have the exact same number of censuses, but Sherman will have
one more census.

-- Suzanne

* Pick stems 1 cm and over (at 1.3 m)

> All trees at least 1 cm diameter at breast height were censused in three sites in Panama. 

-- [Condit et al.](https://dash.ucdavis.edu/stash/dataset/doi:10.15146/R3MM4V)

* Determine year as average or median year by census/plotcensusnumber

> In the datasets, you should look at the "plotcensusnumber" or "censusid"
instead of the years. Some censuses may take more than one year .... The years in the publications refer to the average or the median year.  

-- Suzanne

* Calculate count (abundance) and basal area by site (BCI, Cocoli, Sherman), species, family, year; and spread by year

E.g. https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-saplings-and-trees

Example 1

![](https://i.imgur.com/HxCGK05.png)

[Example 2](https://dash.ucdavis.edu/stash/dataset/doi:10.15146/R3MM4V)

```{r, message=FALSE}
path <- here::here("inst/issues/59_abund_tables/condit_et_al")
sites <- path %>% 
  dir_ls() %>% 
  map(readr::read_delim, "\t") %>% 
  set_names(path_file(dir_ls(path)))
sites
```

```{r}
sites %>% 
  map(select, -Latin, -Family, - Authority) %>% 
  map(names)
```

* Pick alive trees. 

> The three accompanying tables give the population size of living individuals of all species in every census at the three sites. 

-- [Condit et al.](https://dash.ucdavis.edu/stash/dataset/doi:10.15146/R3MM4V)

> Individuals with multiple stems from one root base were counted as single trees. 

-- [Condit et al.](https://dash.ucdavis.edu/stash/dataset/doi:10.15146/R3MM4V)

* TODO: What does this mean? I don't seem to need to standardize by area at all. What am I missing?

> To standardize a density per unit area, each count must be divided by the size of the plot: 50 ha at Barro Colorado, 4 ha at Cocoli, and 5.96 ha at Sherman.

-- [Condit et al.](https://dash.ucdavis.edu/stash/dataset/doi:10.15146/R3MM4V)

# Code

Data.

```{r}
# path_base <- "../fgeo.data/inst/private/data-raw-private"
# path_bci <- here::here(fs::path(path_base, "ViewFullTable_bci.csv"))
# vft_bci <- fgeo.tool::read_vft(path_bci)
# path_sc <- here::here(fs::path(path_base, "ViewFullTable_sherman_cocoli.csv"))
# vft_sc <- fgeo.tool::read_vft(path_sc)
# vft <- bind_rows(vft_bci, vft_sc)
# 
# vft_pick <- sample_n(vft, 10000)
# readr::write_csv(
#   vft_pick, here::here("inst/issues/59_abund_tables/vft_pick.csv")
# )
# readr::write_csv(vft, here::here("inst/issues/59_abund_tables/vft.csv"))
```

TODO: Replace with full size data. Here using a small subset for speed.

```{r}
# vft <- readr::read_csv(here::here("inst/issues/59_abund_tables/vft.csv"))

vft_pick <- readr::read_csv(
  here::here("inst/issues/59_abund_tables/vft_pick.csv")
)
vft_pick
```

## Parameters

```{r}
# @param vft A dataframe; particularly a ForestGEO viewFullTable.
vft <- vft_pick

# @param plot_nm String giving the value of PlotName to pick
plot_nm <- "bci"

# @param status String giving possible values of `Status`.
valid_status <- c("dead", "alive", "broken below", "missing")

# @inheritParams fgeo.tool::filter_status
.status <- "dead"
exclude <- TRUE
```

# Pick useful data

## By the user (before main function)

### PlotName: Chose one plot

Pick the `PlotName` you want. Defaults to use the fist census in alphabetical order.

```{r}
vft_one <- pick_plotname(vft)
```

### DBH: Determine minimum dbh

Pick over 1cm

```{r}
vft_over_one <- fgeo.base::pick_dbh_min(vft_one, 1)
```

## By main function

### Tree status

Check for inconsistent statuses.

```{r vft_warned}
vft_warned <- warn_if_bad_status(vft_over_one, valid_status)
```

Fix wrong status automatically or die trying.

```{r vft_good_status}
vft_good_status <- fix_status_if_bad_or_err(vft_warned, valid_status)
```

Determine the status of each tree based on the status of its (multiple) stem(s).

```{r stts_tree}
stts_tree <- vft_good_status %>% 
  dplyr::group_by(PlotCensusNumber) %>% 
  fgeo.tool::add_status_tree(status_a = "alive", status_d = "dead") %>% 
  dplyr::ungroup()
```

```{r remove-multi-stem, eval=FALSE} 
# TODO: Remove
# If any, view cases of multi-stem trees where `Status` and `status_tree` are
# different.
stts_tree %>% 
  filter(Status != status_tree) %>% 
  group_by(PlotName, PlotCensusNumber) %>% 
  add_count(Tag) %>% 
  arrange(PlotName, PlotCensusNumber, Tag, Status, status_tree) %>% 
  filter(n > 1) %>%
  ungroup() %>% 
  select(matches("status"), Tag, matches("plot"), DBH) %>% 
  print(n = 50)
```

```{r remove-view-missing-dbh, eval=FALSE}
# TODO: Remove
# View example of alive tree with missing DBH.
stts_tree %>% 
  filter(Tag == "021245") %>% 
  select(matches("status"), Tag, matches("plot"), DBH) %>% 
  arrange(PlotName, PlotCensusNumber, Tag, Status, status_tree)
```

* Filter status either by picking "alive" or excluding "dead" (default).

```{r not_dead} 
not_dead <- fgeo.tool::filter_status(
  stts_tree, wood = "tree", .status = .status, exclude = exclude
)
```

### Missing values

* Exclude all rows where `DBH = NA`.

Some alive trees may have missing DBH. I exclude all rows where `DBH = NA` because missing values can't be used for calculating basal area; and althought those rows can be used to count abundance, they are better excluded from abundance tables for consistency with basal area tables.

```{r not_na_dbh} 
not_na_dbh <- drop_if_missing_dbh(not_dead)
```

* Ignore rows where `ExactDate == NA` if any.

```{r missing_dates}
not_na_dates <- drop_if_missing_dates(not_na_dbh)
```

# Compute

## Year

* Calculate year as a round average of `ExactDate` by `PlotCensusNumber`.

```{r} 
with_year <- mean_years(not_na_dates)
```

## Abundance

```{r}
fgeo_abundance <- function(vft) {
  vft %>% 
    dplyr::count(species, Family, year) %>% 
    tidyr::spread(year, n, fill = 0) %>% 
    arrange(species, Family)
  
}

abundance <- fgeo_abundance(with_year)
abundance
```

* Compare

```{r}
select(abundance, 1:7)
```


```{r}
sites$bciAbundTable.tab %>% 
  arrange(Latin) %>% 
  select(1:8, -Authority)
```

## Basal area

```{r}
basal_area <- fgeo_basal_area(with_year)
basal_area
```

# TODO

xxxcont.

* build integral function.
* Find crucial names

* map to all sites (`PlotName`).

* include all rows (not just a small subset).
* Check that tables are ok

# Reference

COUNT

https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-saplings-and-trees

https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-trees

BASAL AREA IN SQUARE METERS

https://forestgeo.si.edu/bci-basal-area-all-tree-species-50-ha-plot-1982-2005-saplings-and-trees

https://forestgeo.si.edu/bci-basal-area-all-tree-species-50-ha-plot-1982-2005-trees
