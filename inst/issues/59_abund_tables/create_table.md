---
title: "Tables of abundance and basal area"
subtitle: BCI, Sherman and Cocoli
author: "Mauro Lepore"
date: "2018-08-20"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    theme: united
    keep_md: true
---



### Setup


```r
library(tidyverse)
library(fgeo)
```

### Implementation-details

[Notes on code development](https://github.com/forestgeo/fgeo.abundance/blob/master/inst/issues/59_abund_tables/count_samplings.md#creating-tables-of-abundance-and-basal-area).


```r
create_table <- function(vft, plotname, table_byyr, ...) {
  vft_plot <- pick_plotname(vft, plotname)
  table_byyr(vft_plot, ...)
}

# Standardize basal area by total plot-hectares.
standardize_ba <- function(ba, denominator) {
  years <- setdiff(names(ba), c("species", "Family"))
  in_he <- convert_unit_at(ba, .at = years, from = "mm2", to = "m2")
  standardize_at(in_he, years, denominator)
}

create_all_tables <- function(vft, plotname, denominator) {
  tree_abund <- create_table(vft, plotname, abundance_byyr, dbh >= 100)
  sap_tree_abund <- create_table(vft, plotname, abundance_byyr, dbh >= 10)
  tree_basal <- create_table(vft, plotname, basal_area_byyr, dbh >= 100) %>% 
    standardize_ba(denominator)
  sap_tree_basal <- create_table(vft, plotname, basal_area_byyr, dbh >= 10) %>% 
    standardize_ba(denominator)
  
  list(
    tree_abundance = tree_abund,
    tree_basal_area = tree_basal,
    sapling_tree_abundance = sap_tree_abund,
    sapling_tree_basal_area = sap_tree_basal
  )
}

write_all_tables <- function(vft, plotname, dir, denominator) {
  tables <- create_all_tables(vft, plotname, denominator)
  fgeo.tool::dfs_to_csv(tables, dir, prefix = paste0(plotname, "_"))
}
```

### Read ViewFullTables


```r
# BCI
path_bci <- here::here("inst/issues/59_abund_tables/vft_bci.csv")
vft_bci <- readr::read_csv(path_bci)

# Sherman and Cocoli
path_sc <- here::here("inst/issues/59_abund_tables/vft_sc.csv")
vft_sc <- readr::read_csv(path_sc)
```

### Create and write tables of abundance and basal area by year


```r
dir <- here::here("inst/issues/59_abund_tables/out")
bci <- vft_bci



# bci <- sample_n(vft_bci, 10)



write_all_tables(bci, plotname = "bci", dir, denominator = 50)

sc <- vft_sc



# sc <- sample_n(vft_sc, 10)



write_all_tables(sc, plotname = "sherman", dir, 5.96)
write_all_tables(sc, plotname = "cocoli", dir, denominator = 4)
```

### Visualize output


```r
folder <- here::here("inst/issues/59_abund_tables/out")
dfs <- csv_to_dfs(folder)
str(dfs, give.attr = FALSE)
#> List of 12
#>  $ bci_sapling_tree_abundance.csv     :Classes 'tbl_df', 'tbl' and 'data.frame':	325 obs. of  10 variables:
#>   ..$ species: chr [1:325] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:325] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1982   : int [1:325] 10 5 1562 79 346 136 385 2 304 175 ...
#>   ..$ 1985   : int [1:325] 10 6 1200 65 315 126 314 2 342 171 ...
#>   ..$ 1990   : int [1:325] 11 11 817 44 280 92 266 3 378 153 ...
#>   ..$ 1995   : num [1:325] 12 12 523 42 219 77 228 2 379 123 ...
#>   ..$ 2000   : int [1:325] 12 10 488 43 163 62 229 1 357 112 ...
#>   ..$ 2005   : int [1:325] 16 21 741 52 143 44 229 1 372 103 ...
#>   ..$ 2010   : int [1:325] 32 47 1019 52 143 40 319 1 417 112 ...
#>   ..$ 2015   : int [1:325] 43 41 1439 62 120 26 266 0 455 97 ...
#>  $ bci_sapling_tree_basal_area.csv    :Classes 'tbl_df', 'tbl' and 'data.frame':	325 obs. of  10 variables:
#>   ..$ species: chr [1:325] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:325] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1982   : num [1:325] 0.002509 0.000882 0.019031 0.003373 0.064738 ...
#>   ..$ 1985   : num [1:325] 0.004079 0.000575 0.019642 0.002342 0.064281 ...
#>   ..$ 1990   : num [1:325] 0.006264 0.000579 0.015985 0.002054 0.061086 ...
#>   ..$ 1995   : num [1:325] 0.008442 0.000982 0.010249 0.001545 0.054615 ...
#>   ..$ 2000   : num [1:325] 0.010818 0.000514 0.008733 0.001587 0.046981 ...
#>   ..$ 2005   : num [1:325] 0.01289 0.00076 0.01 0.00182 0.03996 ...
#>   ..$ 2010   : num [1:325] 0.01526 0.00166 0.01413 0.0018 0.0389 ...
#>   ..$ 2015   : num [1:325] 0.01857 0.00209 0.01971 0.00204 0.03645 ...
#>  $ bci_tree_abundance.csv             :Classes 'tbl_df', 'tbl' and 'data.frame':	253 obs. of  10 variables:
#>   ..$ species: chr [1:253] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:253] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1981   : int [1:253] 2 2 2 2 115 23 161 2 2 30 ...
#>   ..$ 1985   : int [1:253] 2 1 4 0 114 21 159 2 2 32 ...
#>   ..$ 1990   : int [1:253] 2 2 2 2 106 23 158 2 3 27 ...
#>   ..$ 1995   : int [1:253] 3 3 2 1 92 23 156 1 1 27 ...
#>   ..$ 2000   : int [1:253] 3 2 2 2 76 21 146 1 0 22 ...
#>   ..$ 2005   : int [1:253] 4 2 1 2 67 18 145 1 0 28 ...
#>   ..$ 2010   : int [1:253] 7 2 2 1 60 14 133 1 0 34 ...
#>   ..$ 2015   : int [1:253] 7 5 2 0 53 13 128 0 0 34 ...
#>  $ bci_tree_basal_area.csv            :Classes 'tbl_df', 'tbl' and 'data.frame':	253 obs. of  10 variables:
#>   ..$ species: chr [1:253] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:253] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1981   : num [1:253] 0.002297 0.000625 0.00083 0.000808 0.056824 ...
#>   ..$ 1985   : num [1:253] 0.003805 0.000308 0.001277 0 0.057005 ...
#>   ..$ 1990   : num [1:253] 0.005825 0.000396 0.000519 0.000384 0.054215 ...
#>   ..$ 1995   : num [1:253] 0.008077 0.000757 0.000497 0.000219 0.048608 ...
#>   ..$ 2000   : num [1:253] 0.010336 0.00038 0.000547 0.000388 0.042763 ...
#>   ..$ 2005   : num [1:253] 0.012273 0.000434 0.000382 0.000477 0.037071 ...
#>   ..$ 2010   : num [1:253] 0.014749 0.000503 0.000333 0.000373 0.035508 ...
#>   ..$ 2015   : num [1:253] 0.017428 0.001112 0.000376 0 0.033069 ...
#>  $ cocoli_sapling_tree_abundance.csv  :Classes 'tbl_df', 'tbl' and 'data.frame':	175 obs. of  5 variables:
#>   ..$ species: chr [1:175] "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" "Adelia triloba" ...
#>   ..$ Family : chr [1:175] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1994   : int [1:175] 23 14 1 5 2 55 2 2 253 4 ...
#>   ..$ 1997   : int [1:175] 19 18 2 6 1 53 2 1 228 4 ...
#>   ..$ 1998   : int [1:175] 19 22 2 6 1 57 2 1 224 4 ...
#>  $ cocoli_sapling_tree_basal_area.csv :Classes 'tbl_df', 'tbl' and 'data.frame':	175 obs. of  5 variables:
#>   ..$ species: chr [1:175] "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" "Adelia triloba" ...
#>   ..$ Family : chr [1:175] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1994   : num [1:175] 2.00e-03 2.75e-03 2.83e-05 7.64e-03 6.71e-04 ...
#>   ..$ 1997   : num [1:175] 1.25e-03 3.45e-03 7.64e-05 8.33e-03 3.85e-05 ...
#>   ..$ 1998   : num [1:175] 1.29e-03 3.98e-03 7.64e-05 8.57e-03 3.85e-05 ...
#>  $ cocoli_tree_abundance.csv          :Classes 'tbl_df', 'tbl' and 'data.frame':	101 obs. of  5 variables:
#>   ..$ species: chr [1:101] "Adelia triloba" "Albizia adinocephala" "Alchornea costaricensis" "Alseis blackiana" ...
#>   ..$ Family : chr [1:101] "Euphorbiaceae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1994   : int [1:101] 1 9 1 2 125 14 4 5 2 36 ...
#>   ..$ 1997   : int [1:101] 1 6 1 3 121 14 1 5 2 37 ...
#>   ..$ 1998   : int [1:101] 1 6 1 3 122 14 1 5 2 36 ...
#>  $ cocoli_tree_basal_area.csv         :Classes 'tbl_df', 'tbl' and 'data.frame':	101 obs. of  5 variables:
#>   ..$ species: chr [1:101] "Adelia triloba" "Albizia adinocephala" "Alchornea costaricensis" "Alseis blackiana" ...
#>   ..$ Family : chr [1:101] "Euphorbiaceae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1994   : num [1:101] 0.00567 0.07802 0.00233 0.02043 10.48475 ...
#>   ..$ 1997   : num [1:101] 0.00594 0.06062 0.00283 0.02353 10.73914 ...
#>   ..$ 1998   : num [1:101] 0.00594 0.05622 0.00287 0.02404 10.58976 ...
#>  $ sherman_sapling_tree_abundance.csv :Classes 'tbl_df', 'tbl' and 'data.frame':	274 obs. of  7 variables:
#>   ..$ species: chr [1:274] "Abarema barbouriana" "Acacia melanoceras" "Acalypha diversifolia" "Aegiphila panamensis" ...
#>   ..$ Family : chr [1:274] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Lamiaceae" ...
#>   ..$ 1996   : int [1:274] 10 1 9 1 1 92 2 89 41 15 ...
#>   ..$ 1997   : int [1:274] 12 1 7 0 1 89 2 88 38 9 ...
#>   ..$ 1999   : int [1:274] 12 0 5 0 1 93 2 89 38 7 ...
#>   ..$ 2009   : int [1:274] 10 0 20 0 1 95 0 83 37 12 ...
#>   ..$ 2016   : int [1:274] 10 0 14 0 1 81 0 88 33 13 ...
#>  $ sherman_sapling_tree_basal_area.csv:Classes 'tbl_df', 'tbl' and 'data.frame':	274 obs. of  7 variables:
#>   ..$ species: chr [1:274] "Abarema barbouriana" "Acacia melanoceras" "Acalypha diversifolia" "Aegiphila panamensis" ...
#>   ..$ Family : chr [1:274] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Lamiaceae" ...
#>   ..$ 1996   : num [1:274] 2.06e-02 4.27e-05 8.04e-04 1.90e-04 4.91e-03 ...
#>   ..$ 1997   : num [1:274] 2.25e-02 5.27e-05 3.77e-04 0.00 5.01e-03 ...
#>   ..$ 1999   : num [1:274] 0.024731 0 0.000317 0 0.00496 ...
#>   ..$ 2009   : num [1:274] 0.05146 0 0.00137 0 0.00543 ...
#>   ..$ 2016   : num [1:274] 0.07477 0 0.00119 0 0.00543 ...
#>  $ sherman_tree_abundance.csv         :Classes 'tbl_df', 'tbl' and 'data.frame':	149 obs. of  7 variables:
#>   ..$ species: chr [1:149] "Abarema barbouriana" "Alchornea costaricensis" "Alchornea latifolia" "Amaioua corymbosa" ...
#>   ..$ Family : chr [1:149] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1996   : int [1:149] 5 1 15 6 10 4 39 6 80 1 ...
#>   ..$ 1997   : int [1:149] 5 1 17 5 10 3 35 5 79 0 ...
#>   ..$ 1999   : int [1:149] 5 1 18 5 10 2 32 5 79 0 ...
#>   ..$ 2009   : int [1:149] 5 1 16 5 10 0 19 0 83 0 ...
#>   ..$ 2016   : int [1:149] 5 1 15 5 8 0 20 4 87 0 ...
#>  $ sherman_tree_basal_area.csv        :Classes 'tbl_df', 'tbl' and 'data.frame':	149 obs. of  7 variables:
#>   ..$ species: chr [1:149] "Abarema barbouriana" "Alchornea costaricensis" "Alchornea latifolia" "Amaioua corymbosa" ...
#>   ..$ Family : chr [1:149] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1996   : num [1:149] 0.02028 0.00491 0.04015 0.02367 0.05144 ...
#>   ..$ 1997   : num [1:149] 0.022 0.00501 0.04113 0.02276 0.053 ...
#>   ..$ 1999   : num [1:149] 0.02413 0.00496 0.04332 0.02239 0.05431 ...
#>   ..$ 2009   : num [1:149] 0.05009 0.00543 0.04029 0.02147 0.04492 ...
#>   ..$ 2016   : num [1:149] 0.07241 0.00543 0.0358 0.02288 0.0246 ...
```

### Compare with previous tables

Compare with:

* Saplings and trees: https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-saplings-and-trees

* Trees: https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-trees

Also:


```r
folder <- here::here("inst/issues/59_abund_tables/condit_et_al")
paths <- fs::path(folder, dir(folder))
dfs <- map(paths, read_delim, delim = "\t")
set_names(dfs, basename(paths))
#> $bciAbundTable.tsv
#> # A tibble: 328 x 11
#>    Latin Family Authority `1982` `1985` `1990` `1995` `2000` `2005` `2010`
#>    <chr> <chr>  <chr>      <int>  <int>  <int>  <int>  <int>  <int>  <int>
#>  1 Vach~ Fabac~ (Beurl.)~      5      6     11     12     10     21     47
#>  2 Acal~ Eupho~ Jacq.       1562   1200    817    523    488    741   1019
#>  3 Acal~ Eupho~ Jacq.         79     66     44     42     43     52     52
#>  4 Adel~ Eupho~ (Müll.Ar~    346    315    280    219    163    143    143
#>  5 Aegi~ Lamia~ Moldenke     136    126     92     77     62     44     40
#>  6 Alch~ Eupho~ Pax & K.~    385    314    266    228    229    229    319
#>  7 Alch~ Eupho~ Sw.            2      2      3      2      1      1      1
#>  8 Alib~ Rubia~ (Rich.) ~    304    342    378    379    357    372    417
#>  9 Allo~ Sapin~ Radlk.       175    171    153    123    112    103    112
#> 10 Alse~ Rubia~ Hemsl.      7598   8050   8412   8175   7869   7752   7928
#> # ... with 318 more rows, and 1 more variable: `2015` <int>
#> 
#> $cocoliAbundTable.tsv
#> # A tibble: 176 x 6
#>    Latin             Family      Authority            `1994` `1997` `1998`
#>    <chr>             <chr>       <chr>                 <int>  <int>  <int>
#>  1 Acacia melanocer~ Fabaceae    Beurl.                   23     19     19
#>  2 Acalypha diversi~ Euphorbiac~ Jacq.                    14     18     22
#>  3 Acalypha macrost~ Euphorbiac~ Jacq.                     1      2      2
#>  4 Adelia triloba    Euphorbiac~ (Müll.Arg.) Hemsl.        5      6      6
#>  5 Aegiphila paname~ Lamiaceae   Moldenke                  2      1      1
#>  6 Albizia adinocep~ Fabaceae    (Donn. Sm.) Britton~     55     53     57
#>  7 Albizia procera   Fabaceae    (Roxb.) Benth.            2      2      2
#>  8 Alchornea costar~ Euphorbiac~ Pax & K. Hoffm. in ~      2      1      1
#>  9 Alibertia edulis  Rubiaceae   (Rich.) A. Rich.        253    228    224
#> 10 Alseis blackiana  Rubiaceae   Hemsl.                    4      4      4
#> # ... with 166 more rows
#> 
#> $shermanAbundTable.tsv
#> # A tibble: 270 x 7
#>    Latin             Family      Authority     `1996` `1997` `1999` `2009`
#>    <chr>             <chr>       <chr>          <int>  <int>  <int>  <int>
#>  1 Acacia sp.1       Fabaceae    <NA>               0      0      0      4
#>  2 Acacia melanocer~ Fabaceae    Beurl.             1      1      0      0
#>  3 Acalypha diversi~ Euphorbiac~ Jacq.              9      7      5     20
#>  4 Aegiphila paname~ Lamiaceae   Moldenke           1      0      0      0
#>  5 Alchornea sp.3    Euphorbiac~ <NA>              33     24     22     12
#>  6 Alchornea latifo~ Euphorbiac~ Sw.               93     90     94     96
#>  7 Alibertia edulis  Rubiaceae   (Rich.) A. R~      2      2      2      0
#>  8 Amaioua corymbosa Rubiaceae   Kunth             89     88     89     83
#>  9 Andira inermis    Fabaceae    (W. Wright) ~     41     38     38     37
#> 10 Annona spraguei   Annonaceae  Saff.             15      9      7     12
#> # ... with 260 more rows
```

