---
title: "Tables of abundance and basal area"
subtitle: BCI, Sherman and Cocoli
author: "Mauro Lepore"
date: "2018-08-10"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    theme: united
    keep_md: true
---



### Setup


```r
library(tidyverse)
library(fgeo)
```

### Implementation-details

[Notes on code development](https://github.com/forestgeo/fgeo.abundance/blob/master/inst/issues/59_abund_tables/count_samplings.md#creating-tables-of-abundance-and-basal-area).


```r
create_table <- function(vft, plotname, pick_stem_size, table_byyr) {
  vft_plot <- pick_plotname(vft, plotname)
  one_stem_per_treeid <- pick_largest_hom_dbh(vft_plot)
  stems <- pick_stem_size(one_stem_per_treeid)
  table_byyr(stems)
}

# Standardize basal area by total plot-hectares.
standardize_ba <- function(ba, denominator) {
  years <- setdiff(names(ba), c("species", "Family"))
  in_he <- convert_unit_at(ba, .at = years, from = "mm2", to = "m2")
  standardize_at(in_he, years, denominator)
}

create_all_tables <- function(vft, plotname, denominator) {
  tree_abund <- create_table(vft, plotname, pick_trees, abundance_byyr)
  sapling_abund <- create_table(vft, plotname, pick_saplings, abundance_byyr)
  tree_basal <- create_table(vft, plotname, pick_trees, basal_area_byyr) %>% 
    standardize_ba(denominator)
  sapling_basal <- create_table(vft, plotname, pick_saplings, basal_area_byyr) %>% 
    standardize_ba(denominator)
  
  list(
    tree_abundance = tree_abund,
    tree_basal_area = tree_basal,
    sapling_abundance = sapling_abund,
    sapling_basal_area = sapling_basal
  )
}

write_all_tables <- function(vft, plotname, dir, denominator) {
  tables <- create_all_tables(vft, plotname, denominator)
  fgeo.tool::dfs_to_csv(tables, dir, prefix = paste0(plotname, "_"))
}
```

### Read ViewFullTables


```r
# BCI
path_bci <- here::here("inst/issues/59_abund_tables/vft_bci.csv")
vft_bci <- readr::read_csv(path_bci)

# Sherman and Cocoli
path_sc <- here::here("inst/issues/59_abund_tables/vft_sc.csv")
vft_sc <- readr::read_csv(path_sc)
```

### Create and write tables of abundance and basal area by year


```r
dir <- here::here("inst/issues/59_abund_tables/out")
bci <- vft_bci
# bci <- sample_n(vft_bci, 10)
write_all_tables(bci, plotname = "bci", dir, denominator = 50)

sc <- vft_sc
# sc <- sample_n(vft_sc, 10)
write_all_tables(sc, plotname = "sherman", dir, 5.96)
write_all_tables(sc, plotname = "cocoli", dir, denominator = 4)
```

### Visualize output


```r
folder <- here::here("inst/issues/59_abund_tables/out")
dfs <- csv_to_dfs(folder)
str(dfs, give.attr = FALSE)
#> List of 12
#>  $ bci_sapling_abundance.csv     :Classes 'tbl_df', 'tbl' and 'data.frame':	318 obs. of  10 variables:
#>   ..$ species: chr [1:318] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:318] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1982   : int [1:318] 8 3 1560 77 231 113 224 0 302 145 ...
#>   ..$ 1985   : int [1:318] 8 5 1196 65 201 105 155 0 340 139 ...
#>   ..$ 1990   : int [1:318] 9 9 815 42 174 69 108 1 375 126 ...
#>   ..$ 1995   : int [1:318] 9 9 521 41 127 54 72 1 378 96 ...
#>   ..$ 2000   : int [1:318] 9 8 486 41 82 41 82 0 357 89 ...
#>   ..$ 2005   : int [1:318] 12 19 740 50 72 26 83 0 372 75 ...
#>   ..$ 2010   : int [1:318] 25 45 1017 50 78 26 185 0 417 77 ...
#>   ..$ 2015   : int [1:318] 36 36 1437 61 62 13 137 0 455 63 ...
#>  $ bci_sapling_basal_area.csv    :Classes 'tbl_df', 'tbl' and 'data.frame':	318 obs. of  10 variables:
#>   ..$ species: chr [1:318] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:318] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1982   : num [1:318] 0.000211 0.000258 0.018201 0.002564 0.007914 ...
#>   ..$ 1985   : num [1:318] 0.000274 0.000267 0.018364 0.002342 0.007276 ...
#>   ..$ 1990   : num [1:318] 0.000439 0.000184 0.015466 0.001671 0.00687 ...
#>   ..$ 1995   : num [1:318] 0.000365 0.000224 0.009752 0.001326 0.006007 ...
#>   ..$ 2000   : num [1:318] 0.000482 0.000134 0.008186 0.001199 0.00395 ...
#>   ..$ 2005   : num [1:318] 0.000613 0.000327 0.009613 0.00134 0.002764 ...
#>   ..$ 2010   : num [1:318] 0.000511 0.00116 0.013815 0.001384 0.003188 ...
#>   ..$ 2015   : num [1:318] 0.001142 0.000983 0.019351 0.001971 0.003177 ...
#>  $ bci_tree_abundance.csv        :Classes 'tbl_df', 'tbl' and 'data.frame':	253 obs. of  10 variables:
#>   ..$ species: chr [1:253] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:253] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1981   : int [1:253] 2 2 2 2 115 23 161 2 2 30 ...
#>   ..$ 1985   : int [1:253] 2 1 4 0 114 21 159 2 2 32 ...
#>   ..$ 1990   : int [1:253] 2 2 2 2 106 23 158 2 3 27 ...
#>   ..$ 1995   : int [1:253] 3 3 2 1 92 23 156 1 1 27 ...
#>   ..$ 2000   : int [1:253] 3 2 2 2 81 21 147 1 0 23 ...
#>   ..$ 2005   : int [1:253] 4 2 1 2 71 18 146 1 0 28 ...
#>   ..$ 2010   : int [1:253] 7 2 2 2 65 14 134 1 0 35 ...
#>   ..$ 2015   : int [1:253] 7 5 2 1 58 13 129 0 0 34 ...
#>  $ bci_tree_basal_area.csv       :Classes 'tbl_df', 'tbl' and 'data.frame':	253 obs. of  10 variables:
#>   ..$ species: chr [1:253] "Abarema macradenia" "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" ...
#>   ..$ Family : chr [1:253] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1981   : num [1:253] 0.002297 0.000625 0.00083 0.000808 0.056824 ...
#>   ..$ 1985   : num [1:253] 0.003805 0.000308 0.001277 0 0.057005 ...
#>   ..$ 1990   : num [1:253] 0.005825 0.000396 0.000519 0.000384 0.054215 ...
#>   ..$ 1995   : num [1:253] 0.008077 0.000757 0.000497 0.000219 0.048608 ...
#>   ..$ 2000   : num [1:253] 0.010336 0.00038 0.000547 0.000388 0.046889 ...
#>   ..$ 2005   : num [1:253] 0.012273 0.000434 0.000382 0.000477 0.040754 ...
#>   ..$ 2010   : num [1:253] 0.014749 0.000503 0.000333 0.000552 0.039805 ...
#>   ..$ 2015   : num [1:253] 0.017428 0.001112 0.000376 0.000238 0.035888 ...
#>  $ cocoli_sapling_abundance.csv  :Classes 'tbl_df', 'tbl' and 'data.frame':	165 obs. of  5 variables:
#>   ..$ species: chr [1:165] "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" "Adelia triloba" ...
#>   ..$ Family : chr [1:165] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1994   : int [1:165] 23 14 1 4 2 46 2 1 253 2 ...
#>   ..$ 1997   : int [1:165] 19 18 2 5 1 47 2 0 228 1 ...
#>   ..$ 1998   : int [1:165] 19 22 2 5 1 51 2 0 224 1 ...
#>  $ cocoli_sapling_basal_area.csv :Classes 'tbl_df', 'tbl' and 'data.frame':	165 obs. of  5 variables:
#>   ..$ species: chr [1:165] "Acacia melanoceras" "Acalypha diversifolia" "Acalypha macrostachya" "Adelia triloba" ...
#>   ..$ Family : chr [1:165] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Euphorbiaceae" ...
#>   ..$ 1994   : num [1:165] 2.00e-03 2.75e-03 2.83e-05 1.97e-03 6.71e-04 ...
#>   ..$ 1997   : num [1:165] 1.25e-03 3.45e-03 7.64e-05 2.38e-03 3.85e-05 ...
#>   ..$ 1998   : num [1:165] 1.29e-03 3.98e-03 7.64e-05 2.62e-03 3.85e-05 ...
#>  $ cocoli_tree_abundance.csv     :Classes 'tbl_df', 'tbl' and 'data.frame':	101 obs. of  5 variables:
#>   ..$ species: chr [1:101] "Adelia triloba" "Albizia adinocephala" "Alchornea costaricensis" "Alseis blackiana" ...
#>   ..$ Family : chr [1:101] "Euphorbiaceae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1994   : int [1:101] 1 9 1 2 125 14 4 5 2 36 ...
#>   ..$ 1997   : int [1:101] 1 6 1 3 121 14 1 5 2 37 ...
#>   ..$ 1998   : int [1:101] 1 6 1 3 122 14 1 5 2 36 ...
#>  $ cocoli_tree_basal_area.csv    :Classes 'tbl_df', 'tbl' and 'data.frame':	101 obs. of  5 variables:
#>   ..$ species: chr [1:101] "Adelia triloba" "Albizia adinocephala" "Alchornea costaricensis" "Alseis blackiana" ...
#>   ..$ Family : chr [1:101] "Euphorbiaceae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1994   : num [1:101] 0.00567 0.07802 0.00233 0.02043 10.48475 ...
#>   ..$ 1997   : num [1:101] 0.00594 0.06062 0.00283 0.02353 10.73914 ...
#>   ..$ 1998   : num [1:101] 0.00594 0.05622 0.00287 0.02404 10.58976 ...
#>  $ sherman_sapling_abundance.csv :Classes 'tbl_df', 'tbl' and 'data.frame':	268 obs. of  7 variables:
#>   ..$ species: chr [1:268] "Abarema barbouriana" "Acacia melanoceras" "Acalypha diversifolia" "Aegiphila panamensis" ...
#>   ..$ Family : chr [1:268] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Lamiaceae" ...
#>   ..$ 1996   : int [1:268] 5 1 9 1 77 2 83 31 11 61 ...
#>   ..$ 1997   : int [1:268] 7 1 7 0 72 2 83 28 6 36 ...
#>   ..$ 1999   : int [1:268] 7 0 5 0 75 2 84 28 5 33 ...
#>   ..$ 2009   : int [1:268] 5 0 20 0 79 0 78 27 12 52 ...
#>   ..$ 2016   : int [1:268] 5 0 14 0 66 0 83 25 13 59 ...
#>  $ sherman_sapling_basal_area.csv:Classes 'tbl_df', 'tbl' and 'data.frame':	268 obs. of  7 variables:
#>   ..$ species: chr [1:268] "Abarema barbouriana" "Acacia melanoceras" "Acalypha diversifolia" "Aegiphila panamensis" ...
#>   ..$ Family : chr [1:268] "Fabaceae-mimosoideae" "Fabaceae-mimosoideae" "Euphorbiaceae" "Lamiaceae" ...
#>   ..$ 1996   : num [1:268] 3.68e-04 4.27e-05 8.04e-04 1.90e-04 1.89e-02 ...
#>   ..$ 1997   : num [1:268] 5.15e-04 5.27e-05 3.77e-04 0.00 1.58e-02 ...
#>   ..$ 1999   : num [1:268] 0.000602 0 0.000317 0 0.014239 ...
#>   ..$ 2009   : num [1:268] 0.00137 0 0.00137 0 0.01587 ...
#>   ..$ 2016   : num [1:268] 0.00236 0 0.00119 0 0.01585 ...
#>  $ sherman_tree_abundance.csv    :Classes 'tbl_df', 'tbl' and 'data.frame':	149 obs. of  7 variables:
#>   ..$ species: chr [1:149] "Abarema barbouriana" "Alchornea costaricensis" "Alchornea latifolia" "Amaioua corymbosa" ...
#>   ..$ Family : chr [1:149] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1996   : int [1:149] 5 1 15 6 10 4 39 6 80 1 ...
#>   ..$ 1997   : int [1:149] 5 1 17 5 10 3 35 5 79 0 ...
#>   ..$ 1999   : int [1:149] 5 1 18 5 10 2 32 5 79 0 ...
#>   ..$ 2009   : int [1:149] 5 1 16 5 10 0 19 0 83 0 ...
#>   ..$ 2016   : int [1:149] 5 1 15 5 8 0 20 4 87 0 ...
#>  $ sherman_tree_basal_area.csv   :Classes 'tbl_df', 'tbl' and 'data.frame':	149 obs. of  7 variables:
#>   ..$ species: chr [1:149] "Abarema barbouriana" "Alchornea costaricensis" "Alchornea latifolia" "Amaioua corymbosa" ...
#>   ..$ Family : chr [1:149] "Fabaceae-mimosoideae" "Euphorbiaceae" "Euphorbiaceae" "Rubiaceae" ...
#>   ..$ 1996   : num [1:149] 0.02028 0.00491 0.04015 0.02367 0.05144 ...
#>   ..$ 1997   : num [1:149] 0.022 0.00501 0.04113 0.02276 0.053 ...
#>   ..$ 1999   : num [1:149] 0.02413 0.00496 0.04332 0.02239 0.05431 ...
#>   ..$ 2009   : num [1:149] 0.05009 0.00543 0.04029 0.02147 0.04492 ...
#>   ..$ 2016   : num [1:149] 0.07241 0.00543 0.0358 0.02288 0.0246 ...
```

### Compare with previous tables

Compare with:

* Saplings and trees: https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-saplings-and-trees

* Trees: https://forestgeo.si.edu/bci-abundance-all-tree-species-50-ha-plot-1982-2005-trees

Also:


```r
folder <- here::here("inst/issues/59_abund_tables/condit_et_al")
paths <- fs::path(folder, dir(folder))
dfs <- map(paths, read_delim, delim = "\t")
set_names(dfs, basename(paths))
#> $bciAbundTable.tsv
#> # A tibble: 328 x 11
#>    Latin Family Authority `1982` `1985` `1990` `1995` `2000` `2005` `2010`
#>    <chr> <chr>  <chr>      <int>  <int>  <int>  <int>  <int>  <int>  <int>
#>  1 Vach~ Fabac~ (Beurl.)~      5      6     11     12     10     21     47
#>  2 Acal~ Eupho~ Jacq.       1562   1200    817    523    488    741   1019
#>  3 Acal~ Eupho~ Jacq.         79     66     44     42     43     52     52
#>  4 Adel~ Eupho~ (Müll.Ar~    346    315    280    219    163    143    143
#>  5 Aegi~ Lamia~ Moldenke     136    126     92     77     62     44     40
#>  6 Alch~ Eupho~ Pax & K.~    385    314    266    228    229    229    319
#>  7 Alch~ Eupho~ Sw.            2      2      3      2      1      1      1
#>  8 Alib~ Rubia~ (Rich.) ~    304    342    378    379    357    372    417
#>  9 Allo~ Sapin~ Radlk.       175    171    153    123    112    103    112
#> 10 Alse~ Rubia~ Hemsl.      7598   8050   8412   8175   7869   7752   7928
#> # ... with 318 more rows, and 1 more variable: `2015` <int>
#> 
#> $cocoliAbundTable.tsv
#> # A tibble: 176 x 6
#>    Latin             Family      Authority            `1994` `1997` `1998`
#>    <chr>             <chr>       <chr>                 <int>  <int>  <int>
#>  1 Acacia melanocer~ Fabaceae    Beurl.                   23     19     19
#>  2 Acalypha diversi~ Euphorbiac~ Jacq.                    14     18     22
#>  3 Acalypha macrost~ Euphorbiac~ Jacq.                     1      2      2
#>  4 Adelia triloba    Euphorbiac~ (Müll.Arg.) Hemsl.        5      6      6
#>  5 Aegiphila paname~ Lamiaceae   Moldenke                  2      1      1
#>  6 Albizia adinocep~ Fabaceae    (Donn. Sm.) Britton~     55     53     57
#>  7 Albizia procera   Fabaceae    (Roxb.) Benth.            2      2      2
#>  8 Alchornea costar~ Euphorbiac~ Pax & K. Hoffm. in ~      2      1      1
#>  9 Alibertia edulis  Rubiaceae   (Rich.) A. Rich.        253    228    224
#> 10 Alseis blackiana  Rubiaceae   Hemsl.                    4      4      4
#> # ... with 166 more rows
#> 
#> $shermanAbundTable.tsv
#> # A tibble: 270 x 7
#>    Latin             Family      Authority     `1996` `1997` `1999` `2009`
#>    <chr>             <chr>       <chr>          <int>  <int>  <int>  <int>
#>  1 Acacia sp.1       Fabaceae    <NA>               0      0      0      4
#>  2 Acacia melanocer~ Fabaceae    Beurl.             1      1      0      0
#>  3 Acalypha diversi~ Euphorbiac~ Jacq.              9      7      5     20
#>  4 Aegiphila paname~ Lamiaceae   Moldenke           1      0      0      0
#>  5 Alchornea sp.3    Euphorbiac~ <NA>              33     24     22     12
#>  6 Alchornea latifo~ Euphorbiac~ Sw.               93     90     94     96
#>  7 Alibertia edulis  Rubiaceae   (Rich.) A. R~      2      2      2      0
#>  8 Amaioua corymbosa Rubiaceae   Kunth             89     88     89     83
#>  9 Andira inermis    Fabaceae    (W. Wright) ~     41     38     38     37
#> 10 Annona spraguei   Annonaceae  Saff.             15      9      7     12
#> # ... with 260 more rows
```

