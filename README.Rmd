---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# <img src="https://i.imgur.com/m8FNhQR.png" align="right" height=88 /> Abundance, basal area and diversity

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/forestgeo/fgeo.abundance.svg?branch=master)](https://travis-ci.org/forestgeo/fgeo.abundance)
[![Coverage status](https://codecov.io/gh/forestgeo/fgeo.abundance/branch/master/graph/badge.svg)](https://codecov.io/github/forestgeo/fgeo.abundance?branch=master)
[![CRAN status](http://www.r-pkg.org/badges/version/fgeo.abundance)](https://cran.r-project.org/package=fgeo.abundance)

__fgeo.abundance__ calculates abundance, basal area and diversity.

## Installation  

```R
# install.packages("remotes")
remotes::install_github(repo = "forestgeo/fgeo.abundance")
```

For details on how to install packages from GitHub, see [this article](https://goo.gl/dQKEeg).

## Example

```{r}
library(dplyr)
library(fgeo.base)
library(fgeo.abundance)

stem <- fgeo.data::luquillo_stem_random_tiny
```

```{r}
pick <- pick_dbh_min(stem, 10)
pick <- drop_status(pick, "G")
# Same
pick <- stem %>% 
  pick_dbh_min(10) %>% 
  drop_status("G")

pick
```

### Basal area

```{r}
# Add basal area to a dataframe
ba <- basal_area(pick$dbh)
pick$ba <- ba
# Same in one step
pick <- mutate(pick, ba = basal_area(dbh))
# Reordering columns to show `ba` first
select(pick, ba, everything())

# Summarize basal area
basal_area(pick)

# Now by groups
basal_area(group_by(pick, quadrat))
```

### Abundance

```{r}
# Summarize abundance (rows count) by quadrat by species
abundance <- count(pick, quadrat, sp)
abundance

# add_count() is useful for groupwise filtering. E.g.: to pick all data from
# species which abundance per quadrat is under some treshold
with_abundance <- add_count(pick, quadrat, sp)
under_treshold <- filter(with_abundance, n < 20)
select(under_treshold, quadrat, sp, n, everything())
```

### Metrics of diversity

```{r}
vgn_diversity(abundance, n)

# Same result, different format
vegan::specnumber(abundance$n)
vegan::diversity(abundance$n, "shannon")
```

### More ways to count things

`janitor::tabyl()` and `base::table()` are useful tools for counting things.
Their output is sometimes best suited for some analyses, for example with __vegan__.

```{r}
if (!requireNamespace("janitor", quietly = TRUE)) {
  stop(
    "This section uses janitor, install it with:\n",
    "install.packages('janitor')"
  )
}
library(janitor)

# Compare
count(pick, quadrat, sp)

tabyl(pick, quadrat, sp)

# Useful for vegan
freq <- table(pick$quadrat, pick$sp)
freq

vegan::specaccum(freq)

vegan::diversity(freq, "shannon")
```

`janitor::tabyl()` works well with data in 3 dimensions; it outputs a list of dataframes, which are often easier to work with than the output of `base::table()`.

```{r}
tabyl(pick, CensusID, quadrat, sp)

tabyl(pick, CensusID, quadrat, sp, show_missing_levels = FALSE)
```

And makes it easy to format tables by using a declarative style, best suited for composing multiple operations with the pipe (`%>%`) and produces neat output with `knitr::kable()`.

```{r}
tab <- tabyl(pick, quadrat, sp)
tab %>% 
  adorn_totals("row") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_title("top") %>% 
  knitr::kable()
```

## Information

* [Getting help](SUPPORT.md).
* [Contributing](CONTRIBUTING.md).
* [Contributor Code of Conduct](CODE_OF_CONDUCT.md).

## Acknowledgments

Thanks to all partners of ForestGEO, for sharing their ideas and code. Special 
thanks for inspiring ideas to David Kenfack and Jenny Bryan ([\@JennyBryan](https://twitter.com/JennyBryan)).
