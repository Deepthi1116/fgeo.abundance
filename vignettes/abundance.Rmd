---
title: "Abundance and Basal Area"
author: "Mauro Lepore"
date: "2017-10-25"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 6
vignette: >
  %\VignetteIndexEntry{Abundance and Basal Area}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# hadley's settings
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,  # {mine}
  comment = "#>",
  collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

options(dplyr.print_min = 10, dplyr.print_max = 10)
```

# Overview

This vignette shows you how to calculate abundance and basal area with the functions `abundance()`, `basal_area()`, and friends from the __fgeo.abundance__ package -- let's load it now:

```{r}
# install.packages("remotes")
remotes::install_github(repo = "forestgeo/fgeo.abundance")
library(fgeo.abundance)
```

# Abundance

The function `abundance()` provides a quick way to calculate the abundance of alive stems of each species in each quadrat -- that is what it does by default (see `abundance()`):

```{r}
stem <- bciex::bci12s7mini

n <- abundance(stem)
head(n)

# Of course you can change the defaults
head(abundance(stem, "sp", only_alive = FALSE))
```

So you can get consistent output, `abundance()` always returns a dataframe. If what you want is a single number giving the total abundance of alive stems, then you can use `abundance_tally()`.

```{r, error=TRUE}
abundance_tally(stem)
abundance_tally(stem, only_alive = FALSE)

# This won't work
fails <- abundance(stem, group_by = NULL)
```

In R there is always more than one way to get the same result. An alternative is to use __dplyr__, and instead of passing _"quoted grouping variables"__, you can pass __bare grouping variables__. No approach is good or bad -- the most suitable one depends on the situation

```{r, error=TRUE}
# With fgeo.abundance you can assign a string of variable names and pass use it later
quoted_vars <- c("quadrat", "sp")
with_fgeo.abundance <- abundance(stem, quoted_vars)

# Compare
library(dplyr)
alive <- dplyr::filter(stem, status == "A")
# With dplyr you use bare variable names
with_dplyr <- dplyr::count(alive, quadrat, sp)

# You cant reuse grouping variables saved as strings
# (other tricks work but are beyond the scope of this tutorial)
fails <- dplyr::count(alive, quoted_vars)
# This also fails, not but trowing an error but by giving the wrong output
also_fails <- dplyr::count(alive, "quadrat", "sp")

# Whatever you choose, if you do it right you get the same results
alternatives <- list(with_fgeo.abundance, with_dplyr)
lapply(alternatives, head)

is_var_identical <- function(x, y, var) {identical(x[["var"]], y[["var"]])}
is_var_identical(with_fgeo.abundance, with_dplyr, "quadrat")
is_var_identical(with_fgeo.abundance, with_dplyr, "sp")
is_var_identical(with_fgeo.abundance, with_dplyr, "n")
```


# Basal Area

Compared to `abundance()`, `basal_area()` behaves very similarly: it provides a quick way to calculate the basal area of alive trees of each species within each quadrat:

```{r}
stem <- bciex::bci12s7mini
ba <- basal_area(stem)
head(ba)

# Same but silent
silent <- suppressMessages(basal_area(stem))
head(silent)
```

Instead if you want the basal area of each individual stem, use `basal_area_ind()`:

```{r}
ba <- basal_area_ind(stem$dbh)
head(ba)

# Why NAs?
head(stem$dbh)
# because `dbh` is na in the data set
```

